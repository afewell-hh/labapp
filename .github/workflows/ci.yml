---
name: CI

"on":
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Bash Syntax Check
        run: |
          echo "Checking shell syntax with bash -n"
          EXIT_CODE=0
          find . -name "*.sh" -type f | while read script; do
            echo "Validating: $script"
            if ! bash -n "$script"; then
              echo "❌ Syntax error in: $script"
              EXIT_CODE=1
            fi
          done
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Shell syntax validation failed"
            exit 1
          fi
          echo "✓ All shell scripts passed syntax validation"

      - name: Shellcheck
        run: |
          sudo apt-get install -y shellcheck
          echo "Running shellcheck on all shell scripts"
          EXIT_CODE=0
          if [ -d packer/scripts ]; then
            find packer/scripts -name "*.sh" \
              -exec shellcheck -x {} \; || EXIT_CODE=1
          fi
          if [ -d scripts ]; then
            find scripts -name "*.sh" \
              -exec shellcheck -x {} \; || EXIT_CODE=1
          fi
          if [ -d tests/e2e/scripts ]; then
            find tests/e2e/scripts -name "*.sh" \
              -exec shellcheck -x {} \; || EXIT_CODE=1
          fi
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Shellcheck found issues"
            exit 1
          fi
          echo "✓ All shell scripts passed shellcheck"

      - name: YAML Lint
        run: |
          pip install yamllint
          if [ -d configs ]; then
            yamllint configs/ || true
          fi
          yamllint .github/workflows/

  validate:
    name: Validate Packer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: '1.11.2'

      - name: Initialize Packer
        run: |
          if [ -f packer/standard-build.pkr.hcl ]; then
            packer init packer/standard-build.pkr.hcl
          fi
        env:
          PACKER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate standard build
        run: |
          if [ -f packer/standard-build.pkr.hcl ]; then
            packer validate packer/standard-build.pkr.hcl
            echo "✓ Standard build template is valid"
          else
            echo "Packer file not yet created, skipping validation"
          fi

      - name: Format check
        run: |
          if [ -f packer/standard-build.pkr.hcl ]; then
            packer fmt -check packer/standard-build.pkr.hcl
          fi

      - name: Validate pre-warmed build
        run: |
          if [ -f packer/prewarmed-build.pkr.hcl ]; then
            packer init packer/prewarmed-build.pkr.hcl
            packer validate packer/prewarmed-build.pkr.hcl
            echo "✓ Pre-warmed build template is valid"
          else
            echo "Pre-warmed build not yet implemented, skipping validation"
          fi
        env:
          PACKER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Format Check
        run: |
          echo "Checking Terraform formatting"
          EXIT_CODE=0
          for dir in terraform/*/; do
            if [ -f "$dir/main.tf" ]; then
              echo "Checking format: $dir"
              if ! terraform -chdir="$dir" fmt -check -recursive; then
                echo "❌ Formatting issues in: $dir"
                EXIT_CODE=1
              fi
            fi
          done
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Run 'terraform fmt -recursive' to fix formatting"
            exit 1
          fi
          echo "✓ All Terraform files are properly formatted"

      - name: Terraform Validate
        run: |
          echo "Validating Terraform configurations"
          EXIT_CODE=0
          for dir in terraform/*/; do
            if [ -f "$dir/main.tf" ]; then
              echo "Validating: $dir"
              cd "$dir"
              # Initialize without backend (validation only)
              if ! terraform init -backend=false; then
                echo "❌ Terraform init failed in: $dir"
                EXIT_CODE=1
                cd - > /dev/null
                continue
              fi
              # Validate configuration
              if ! terraform validate; then
                echo "❌ Terraform validation failed in: $dir"
                EXIT_CODE=1
              fi
              cd - > /dev/null
            fi
          done
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Terraform validation failed"
            exit 1
          fi
          echo "✓ All Terraform configurations are valid"

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run orchestrator tests
        run: |
          # TODO: Implement test suite
          echo "Tests will be implemented in future PR"
