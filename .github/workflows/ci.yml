---
name: CI

"on":
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Bash Syntax Check
        run: |
          echo "Checking shell syntax with bash -n"
          EXIT_CODE=0
          # Exclude _archive directory and bats test files
          while IFS= read -r -d '' script; do
            # Skip archived files
            if [[ "$script" == ./_archive/* ]]; then
              continue
            fi
            # Skip bats test files (they use different syntax)
            if head -1 "$script" | grep -q "bats"; then
              echo "Skipping bats file: $script"
              continue
            fi
            echo "Validating: $script"
            if ! bash -n "$script"; then
              echo "❌ Syntax error in: $script"
              EXIT_CODE=1
            fi
          done < <(find . -name "*.sh" -type f -print0)
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Shell syntax validation failed"
            exit 1
          fi
          echo "✓ All shell scripts passed syntax validation"

      - name: Shellcheck
        run: |
          sudo apt-get install -y shellcheck
          echo "Running shellcheck on installer scripts"
          EXIT_CODE=0
          # Only check active directories, not _archive
          if [ -d packer/scripts ]; then
            find packer/scripts -name "*.sh" \
              -exec shellcheck -x {} \; || EXIT_CODE=1
          fi
          if [ -d scripts ]; then
            find scripts -name "*.sh" \
              -exec shellcheck -x {} \; || EXIT_CODE=1
          fi
          if [ -d tests/e2e/scripts ]; then
            find tests/e2e/scripts -name "*.sh" \
              -exec shellcheck -x {} \; || EXIT_CODE=1
          fi
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Shellcheck found issues"
            exit 1
          fi
          echo "✓ All shell scripts passed shellcheck"

      - name: YAML Lint
        run: |
          pip install yamllint
          if [ -d configs ]; then
            yamllint configs/ || true
          fi
          yamllint .github/workflows/

  validate-systemd:
    name: Validate Systemd Services
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check systemd service configurations
        run: |
          echo "Validating systemd service files..."
          EXIT_CODE=0

          # Check hhfab-vlab.service for critical settings
          SERVICE_FILE="packer/scripts/hhfab-vlab.service"

          if [ ! -f "$SERVICE_FILE" ]; then
            echo "❌ Service file not found: $SERVICE_FILE"
            EXIT_CODE=1
          else
            echo "Checking $SERVICE_FILE..."

            # Check for PrivateTmp=true (blocks tmux access)
            if grep -q "^PrivateTmp=true" "$SERVICE_FILE"; then
              echo "❌ Service uses PrivateTmp=true (blocks tmux socket access)"
              EXIT_CODE=1
            fi

            # Check for Type=forking (causes blocking)
            if grep -q "^Type=forking" "$SERVICE_FILE"; then
              echo "❌ Service uses Type=forking (causes indefinite blocking)"
              EXIT_CODE=1
            fi

            # Verify Type=oneshot is used
            if ! grep -q "^Type=oneshot" "$SERVICE_FILE"; then
              echo "❌ Service should use Type=oneshot"
              EXIT_CODE=1
            fi

            # Verify TimeoutStartSec is set
            if ! grep -q "^TimeoutStartSec=" "$SERVICE_FILE"; then
              echo "❌ Service should have TimeoutStartSec set"
              EXIT_CODE=1
            fi

            # Verify ConditionPathExists prevents re-runs
            if ! grep -q "ConditionPathExists=!" "$SERVICE_FILE"; then
              echo "❌ Service should have ConditionPathExists to prevent"\
                   "re-initialization"
              EXIT_CODE=1
            fi

            echo "✓ Service file validation passed"
          fi

          if [ $EXIT_CODE -ne 0 ]; then
            echo "Systemd service validation failed"
            exit 1
          fi
          echo "✓ All systemd services are correctly configured"

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Make test scripts executable
        run: |
          find tests/unit -name "*.sh" -type f -exec chmod +x {} \;

      - name: Run orchestrator ordering tests
        run: |
          echo "Running orchestrator ordering tests..."
          tests/unit/test-orchestrator-ordering.sh

      - name: Run systemd service tests
        run: |
          echo "Running systemd service tests..."
          tests/unit/test-systemd-services.sh

      - name: Run first-boot setup tests
        run: |
          echo "Running first-boot setup tests..."
          if [ -f tests/unit/test-first-boot-setup.sh ]; then
            tests/unit/test-first-boot-setup.sh
          else
            echo "Test file not found, skipping"
          fi

      - name: Run VLAB readiness tests
        run: |
          echo "Running VLAB readiness tests..."
          if [ -f tests/unit/test-vlab-readiness.sh ]; then
            tests/unit/test-vlab-readiness.sh
          else
            echo "Test file not found, skipping"
          fi

      - name: Test Summary
        if: always()
        run: |
          echo "Unit test execution complete"

  test-modules:
    name: Test Modules and Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run module validation tests
        run: |
          echo "Running module validation tests..."
          make test-modules

  validate-installer:
    name: Validate Installer Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check installer scripts exist
        run: |
          echo "Validating installer scripts..."
          EXIT_CODE=0

          # Check core installer files exist
          REQUIRED_FILES=(
            "packer/scripts/01-install-base.sh"
            "packer/scripts/02-install-k3d.sh"
            "packer/scripts/03-install-hhfab.sh"
            "packer/scripts/20-k3d-observability-init.sh"
            "packer/scripts/30-vlab-init.sh"
            "packer/scripts/hhfab-vlab-runner"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              EXIT_CODE=1
            else
              echo "✓ Found: $file"
            fi
          done

          if [ $EXIT_CODE -ne 0 ]; then
            echo "Installer validation failed"
            exit 1
          fi
          echo "✓ All required installer files present"
