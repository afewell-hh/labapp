---
name: CI

"on":
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Shellcheck
        run: |
          sudo apt-get install -y shellcheck
          if [ -d packer/scripts ]; then
            find packer/scripts -name "*.sh" -exec shellcheck {} \;
          fi
          if [ -d scripts ]; then
            find scripts -name "*.sh" -exec shellcheck {} \;
          fi

      - name: YAML Lint
        run: |
          pip install yamllint
          if [ -d configs ]; then
            yamllint configs/ || true
          fi
          yamllint .github/workflows/

  validate:
    name: Validate Packer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: '1.11.2'

      - name: Initialize Packer
        run: |
          if [ -f packer/standard-build.pkr.hcl ]; then
            packer init packer/standard-build.pkr.hcl
          fi
        env:
          PACKER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate standard build
        run: |
          if [ -f packer/standard-build.pkr.hcl ]; then
            packer validate packer/standard-build.pkr.hcl
            echo "✓ Standard build template is valid"
          else
            echo "Packer file not yet created, skipping validation"
          fi

      - name: Format check
        run: |
          if [ -f packer/standard-build.pkr.hcl ]; then
            packer fmt -check packer/standard-build.pkr.hcl
          fi

      - name: Validate pre-warmed build
        run: |
          if [ -f packer/prewarmed-build.pkr.hcl ]; then
            packer init packer/prewarmed-build.pkr.hcl
            packer validate packer/prewarmed-build.pkr.hcl
            echo "✓ Pre-warmed build template is valid"
          else
            echo "Pre-warmed build not yet implemented, skipping validation"
          fi
        env:
          PACKER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run orchestrator tests
        run: |
          # TODO: Implement test suite
          echo "Tests will be implemented in future PR"
