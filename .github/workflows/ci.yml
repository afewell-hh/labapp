---
name: CI

"on":
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Bash Syntax Check
        run: |
          echo "Checking shell syntax with bash -n"
          EXIT_CODE=0
          while IFS= read -r -d '' script; do
            echo "Validating: $script"
            if ! bash -n "$script"; then
              echo "❌ Syntax error in: $script"
              EXIT_CODE=1
            fi
          done < <(find . -name "*.sh" -type f -print0)
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Shell syntax validation failed"
            exit 1
          fi
          echo "✓ All shell scripts passed syntax validation"

      - name: Shellcheck
        run: |
          sudo apt-get install -y shellcheck
          echo "Running shellcheck on all shell scripts"
          EXIT_CODE=0
          if [ -d packer/scripts ]; then
            find packer/scripts -name "*.sh" \
              -exec shellcheck -x {} \; || EXIT_CODE=1
          fi
          if [ -d scripts ]; then
            find scripts -name "*.sh" \
              -exec shellcheck -x {} \; || EXIT_CODE=1
          fi
          if [ -d tests/e2e/scripts ]; then
            find tests/e2e/scripts -name "*.sh" \
              -exec shellcheck -x {} \; || EXIT_CODE=1
          fi
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Shellcheck found issues"
            exit 1
          fi
          echo "✓ All shell scripts passed shellcheck"

      - name: YAML Lint
        run: |
          pip install yamllint
          if [ -d configs ]; then
            yamllint configs/ || true
          fi
          yamllint .github/workflows/

  validate:
    name: Validate Packer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: '1.11.2'

      - name: Initialize Packer
        run: |
          if [ -f packer/standard-build.pkr.hcl ]; then
            packer init packer/standard-build.pkr.hcl
          fi
        env:
          PACKER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate standard build
        run: |
          if [ -f packer/standard-build.pkr.hcl ]; then
            packer validate packer/standard-build.pkr.hcl
            echo "✓ Standard build template is valid"
          else
            echo "Packer file not yet created, skipping validation"
          fi

      - name: Format check
        run: |
          if [ -f packer/standard-build.pkr.hcl ]; then
            packer fmt -check packer/standard-build.pkr.hcl
          fi

      - name: Validate pre-warmed build
        run: |
          if [ -f packer/prewarmed-build.pkr.hcl ]; then
            packer init packer/prewarmed-build.pkr.hcl
            packer validate packer/prewarmed-build.pkr.hcl
            echo "✓ Pre-warmed build template is valid"
          else
            echo "Pre-warmed build not yet implemented, skipping validation"
          fi
        env:
          PACKER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Format Check
        run: |
          echo "Checking Terraform formatting"
          EXIT_CODE=0
          for dir in terraform/*/; do
            if [ -f "$dir/main.tf" ]; then
              echo "Checking format: $dir"
              if ! terraform -chdir="$dir" fmt -check -recursive; then
                echo "❌ Formatting issues in: $dir"
                EXIT_CODE=1
              fi
            fi
          done
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Run 'terraform fmt -recursive' to fix formatting"
            exit 1
          fi
          echo "✓ All Terraform files are properly formatted"

      - name: Terraform Validate
        run: |
          echo "Validating Terraform configurations"
          EXIT_CODE=0
          for dir in terraform/*/; do
            if [ -f "$dir/main.tf" ]; then
              echo "Validating: $dir"
              cd "$dir"
              # Initialize without backend (validation only)
              if ! terraform init -backend=false; then
                echo "❌ Terraform init failed in: $dir"
                EXIT_CODE=1
                cd - > /dev/null
                continue
              fi
              # Validate configuration
              if ! terraform validate; then
                echo "❌ Terraform validation failed in: $dir"
                EXIT_CODE=1
              fi
              cd - > /dev/null
            fi
          done
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Terraform validation failed"
            exit 1
          fi
          echo "✓ All Terraform configurations are valid"

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Make test scripts executable
        run: |
          find tests/unit -name "*.sh" -type f -exec chmod +x {} \;

      - name: Run orchestrator ordering tests
        run: |
          echo "Running orchestrator ordering tests..."
          tests/unit/test-orchestrator-ordering.sh

      - name: Run systemd service tests
        run: |
          echo "Running systemd service tests..."
          tests/unit/test-systemd-services.sh

      - name: Run GCP build script tests
        run: |
          echo "Running GCP build script tests..."
          tests/unit/test-gcp-build-script.sh

      - name: Run publish-to-gcs script tests
        run: |
          echo "Running publish-to-gcs script tests..."
          tests/unit/test-publish-to-gcs.sh

      - name: Test Summary
        if: always()
        run: |
          echo "Unit test execution complete"
          echo "All orchestrator, systemd service, GCP build script, and"
          echo "publish-to-gcs validations passed"

  validate-systemd:
    name: Validate Systemd Services
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check systemd service configurations
        run: |
          echo "Validating systemd service files..."
          EXIT_CODE=0

          # Check hhfab-vlab.service for critical settings
          SERVICE_FILE="packer/scripts/hhfab-vlab.service"

          if [ ! -f "$SERVICE_FILE" ]; then
            echo "❌ Service file not found: $SERVICE_FILE"
            EXIT_CODE=1
          else
            echo "Checking $SERVICE_FILE..."

            # Check for PrivateTmp=true (blocks tmux access)
            if grep -q "^PrivateTmp=true" "$SERVICE_FILE"; then
              echo "❌ Service uses PrivateTmp=true (blocks tmux socket access)"
              EXIT_CODE=1
            fi

            # Check for Type=forking (causes blocking)
            if grep -q "^Type=forking" "$SERVICE_FILE"; then
              echo "❌ Service uses Type=forking (causes indefinite blocking)"
              EXIT_CODE=1
            fi

            # Verify Type=oneshot is used
            if ! grep -q "^Type=oneshot" "$SERVICE_FILE"; then
              echo "❌ Service should use Type=oneshot"
              EXIT_CODE=1
            fi

            # Verify TimeoutStartSec is set
            if ! grep -q "^TimeoutStartSec=" "$SERVICE_FILE"; then
              echo "❌ Service should have TimeoutStartSec set"
              EXIT_CODE=1
            fi

            # Verify ConditionPathExists prevents re-runs
            if ! grep -q "ConditionPathExists=!" "$SERVICE_FILE"; then
              echo "❌ Service should have ConditionPathExists to prevent"\
                   "re-initialization"
              EXIT_CODE=1
            fi

            echo "✓ Service file validation passed"
          fi

          if [ $EXIT_CODE -ne 0 ]; then
            echo "Systemd service validation failed"
            exit 1
          fi
          echo "✓ All systemd services are correctly configured"

  validate-packer-provisioners:
    name: Validate Packer Provisioners
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Packer provisioners completeness
        run: |
          echo "Validating Packer provisioners include all required files..."
          EXIT_CODE=0

          PACKER_FILE="packer/standard-build.pkr.hcl"
          INSTALL_SCRIPT="packer/scripts/05-install-orchestrator.sh"

          # Extract files referenced in installation script
          echo "Checking files referenced in $INSTALL_SCRIPT..."

          # Files that should have Packer provisioners
          REQUIRED_FILES=(
            "hedgehog-lab-orchestrator"
            "hedgehog-lab-init.service"
            "20-k3d-observability-init.sh"
            "30-vlab-init.sh"
            "hhfab-vlab-runner"
            "hhfab-vlab.service"
            "hedgehog-lab-readiness-ui"
            "hh-lab"
            "hh-lab-completion.bash"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if ! grep -q "source.*packer/scripts/$file" "$PACKER_FILE"; then
              echo "❌ Missing Packer provisioner for: $file"
              EXIT_CODE=1
            fi
          done

          if [ $EXIT_CODE -ne 0 ]; then
            echo "Packer provisioner validation failed"
            echo "All files referenced in installation scripts must have"\
                 "file provisioners in Packer template"
            exit 1
          fi
          echo "✓ All required files have Packer provisioners"

  test-modules:
    name: Test Modules and Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run module validation tests
        run: |
          echo "Running module validation tests..."
          make test-modules

      - name: Test GCP build script dry-run
        run: |
          echo "Testing GCP build script dry-run..."
          # Create minimal .env.gcp for dry-run validation
          cat > .env.gcp <<EOF
          GCP_PROJECT_ID="test-project"
          GCP_ZONE="us-central1-a"
          GCS_BUCKET="test-bucket"
          EOF

          # Run dry-run to validate argument parsing and script logic
          # Expected to fail at gcloud auth check, but should validate
          # argument parsing
          ./scripts/launch-gcp-build.sh --dry-run main || \
            echo "Dry-run validation complete (gcloud auth expected" \
                 "to fail in CI)"
