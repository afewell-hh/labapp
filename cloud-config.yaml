#cloud-config
# SETUP: Educational, single-user VM for Hedgehog VLab on GCP.
# Features: RDP/SSH access, static password, automatic root login, all dependencies.

write_files:
  - path: /root/install_core_packages.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      set -ex

      echo "--- Starting core package installation ---"

      export DEBIAN_FRONTEND=noninteractive

      apt-get update

      # Install packages that were inconsistently installed by the apt module
      apt-get install -y \
        vim git curl wget build-essential \
        software-properties-common apt-transport-https \
        ca-certificates gnupg lsb-release jq unzip zip tar gzip \
        dnsutils iputils-ping traceroute tcpdump htop iotop iftop \
        tmux screen tree rsync qemu-kvm socat yq kustomize nano gh

      echo "--- Core package installation finished ---"

  - path: /root/install_tools.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      set -ex
      
      echo "--- Installing kubectl and helm ---"
      curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
      rm kubectl

      curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
      chmod 700 get_helm.sh
      ./get_helm.sh
      rm get_helm.sh
      
      echo "--- Kubernetes tooling installed ---"

      echo "Starting Docker installation..."
      curl -fsSL https://get.docker.com -o /tmp/install-docker.sh
      sh /tmp/install-docker.sh
      
      usermod -aG docker ubuntu
      usermod -aG kvm ubuntu
      
      echo "--- Group Membership Configured ---"
      
      echo "Installing ORAS..."
      curl -fsSL https://i.hhdev.io/oras | bash
      
      echo "Installing K3d..."
      curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | TAG=v5.7.4 bash
      
      echo "--- Additional tools installation finished ---"

  - path: /root/config_rdp.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      set -ex

      echo "--- Configuring XRDP for XFCE4 Session ---"
      cat << EOF > /etc/xrdp/startwm.sh
      #!/bin/sh
      if test -r /etc/profile; then
        . /etc/profile
      fi
      if test -r ~/.profile; then
        . ~/.profile
      fi
      startxfce4
      EOF
      chmod +x /etc/xrdp/startwm.sh
  
  - path: /home/ubuntu/.local/share/applications/Firefox.desktop
    permissions: '0755'
    owner: ubuntu:ubuntu
    content: |
      [Desktop Entry]
      Version=1.0
      Type=Application
      Name=Firefox
      Comment=Access the Web
      Exec=bash -c 'source ~/.bashrc && firefox %u'
      Icon=firefox
      Categories=Network;WebBrowser;
      Terminal=false
      StartupNotify=true

  - path: /home/ubuntu/.local/share/applications/VSCode.desktop
    permissions: '0755'
    owner: ubuntu:ubuntu
    content: |
      [Desktop Entry]
      Version=1.0
      Type=Application
      Name=Visual Studio Code
      Comment=Code Editing. Redefined.
      Exec=/usr/bin/code
      Icon=vscode
      Categories=Utility;TextEditor;Development;IDE;
      Terminal=false
      StartupNotify=true

  - path: /home/ubuntu/.config/mimeapps.list
    permissions: '0644'
    owner: ubuntu:ubuntu
    content: |
      [Default Applications]
      text/html=firefox.desktop
      x-scheme-handler/http=firefox.desktop
      x-scheme-handler/https=firefox.desktop
      x-scheme-handler/about=firefox.desktop
      x-scheme-handler/unknown=firefox.desktop

runcmd:
  # Install core packages (the previously problematic ones)
  - /root/install_core_packages.sh

  # RDP and System Access Setup (restored to original working config)
  - DEBIAN_FRONTEND=noninteractive apt-get update
  - DEBIAN_FRONTEND=noninteractive apt-get install -y net-tools
  - DEBIAN_FRONTEND=noninteractive apt-get install -y xrdp
  - DEBIAN_FRONTEND=noninteractive apt-get install -y xfce4 xfce4-goodies
  - /root/config_rdp.sh
  - echo "ubuntu:HHLab.Admin!" | chpasswd
  - echo xfce4-session > /etc/skel/.xsession
  - echo "Xfce session set as default for new users."
  - systemctl enable xrdp
  - systemctl restart xrdp

  # Install Node.js
  - 'curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -'
  - 'sudo apt-get update'
  - 'sudo apt-get install -y nodejs'

  # Install Firefox (from apt)
  - 'DEBIAN_FRONTEND=noninteractive apt-get install -y firefox'

  # Install VS Code
  - curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
  - sudo install -o root -g root -m 644 microsoft.gpg /etc/apt/trusted.gpg.d/
  - sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main" > /etc/apt/sources.list.d/vscode.list'
  - sudo apt update
  - sudo apt install -y code

  # Execute other combined installation scripts
  - /root/install_tools.sh

  # Install hhfab after the install_tools.sh to ensure dependencies are met
  - echo "Installing HHFAB..."
  - 'sudo -H sh -c "curl -fsSL https://i.hhdev.io/hhfab | bash"'
  - echo "--- HHFAB installation finished ---"

  # Desktop Experience Improvements
  - update-alternatives --set x-terminal-emulator /usr/bin/xfce4-terminal.wrapper
  - sudo chown -R ubuntu:ubuntu /home/ubuntu/Desktop /home/ubuntu/.config
  - echo 'export DISPLAY=:10.0' >> /home/ubuntu/.bashrc
  - echo 'export XAUTHORITY=/home/ubuntu/.Xauthority' >> /home/ubuntu/.bashrc
  - sudo -u ubuntu xfconf-query -c xfwm4 -p /general/use_compositing -s false
