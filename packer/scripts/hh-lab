#!/bin/bash
# hh-lab
# Command-line tool for Hedgehog Lab Appliance management
# Provides status, logs, and info commands for lab management

set -euo pipefail

# Version
VERSION="0.1.0"

# Configuration paths
STATE_FILE="/var/lib/hedgehog-lab/state.json"
STAMP_FILE="/var/lib/hedgehog-lab/initialized"
BUILD_TYPE_FILE="/etc/hedgehog-lab/build-type"
LOG_FILE="/var/log/hedgehog-lab-init.log"
MODULE_LOG_DIR="/var/log/hedgehog-lab/modules"
GHCR_CREDS_MARKER="/var/lib/hedgehog-lab/ghcr-authenticated"
SETUP_LOG="/var/log/hedgehog-lab/setup.log"

# ANSI color codes for colored output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m' # No Color

# Color output functions
print_header() {
    echo -e "${BOLD}${BLUE}$*${NC}"
}

print_success() {
    echo -e "${GREEN}✓${NC} $*"
}

print_error() {
    echo -e "${RED}✗${NC} $*"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $*"
}

print_info() {
    echo -e "${CYAN}ℹ${NC} $*"
}

print_label() {
    echo -e "${DIM}$1:${NC} $2"
}

print_status_ok() {
    echo -e "[${GREEN}OK${NC}]"
}

print_status_fail() {
    echo -e "[${RED}FAIL${NC}]"
}

print_status_pending() {
    echo -e "[${YELLOW}PENDING${NC}]"
}

# Check if running with appropriate permissions
check_permissions() {
    if [ ! -r "$STATE_FILE" ] 2>/dev/null && [ -f "$STATE_FILE" ]; then
        print_error "Permission denied. Some commands may require sudo."
        return 1
    fi
    return 0
}

# Parse JSON fields from state file
get_state_field() {
    local field="$1"
    if [ ! -f "$STATE_FILE" ]; then
        echo "unknown"
        return
    fi
    # Simple JSON parsing using grep and sed (avoids jq dependency)
    grep "\"$field\"" "$STATE_FILE" | sed 's/.*: "\?\([^",]*\)"\?,\?/\1/' | tr -d ' '
}

# Get array length from JSON
get_array_length() {
    local field="$1"
    if [ ! -f "$STATE_FILE" ]; then
        echo "0"
        return
    fi
    grep "\"$field\"" "$STATE_FILE" -A 1 | grep -o "\"[^\"]*\"" | wc -l
}

# Helper function to check Kubernetes deployment status
check_k8s_deployment() {
    local namespace="$1"
    local deployment="$2"
    local label_selector="${3:-}"

    if ! command -v kubectl &> /dev/null; then
        echo "unknown"
        return
    fi

    if ! kubectl cluster-info &> /dev/null; then
        echo "no-cluster"
        return
    fi

    # Check if namespace exists
    if ! kubectl get namespace "$namespace" &> /dev/null; then
        echo "not-deployed"
        return
    fi

    # Check deployment or pods with label selector
    if [ -n "$label_selector" ]; then
        local ready_pods
        ready_pods=$(kubectl get pods -n "$namespace" -l "$label_selector" --field-selector=status.phase=Running 2>/dev/null | grep -c "Running" || echo "0")
        # Ensure ready_pods is numeric before comparison
        ready_pods="${ready_pods:-0}"
        if [ "$ready_pods" -gt 0 ]; then
            echo "running"
        else
            echo "not-ready"
        fi
    else
        if kubectl get deployment -n "$namespace" "$deployment" &> /dev/null; then
            local available
            available=$(kubectl get deployment -n "$namespace" "$deployment" -o jsonpath='{.status.availableReplicas}' 2>/dev/null || echo "0")
            # Ensure available is numeric before comparison (handles empty/null values)
            available="${available:-0}"
            if [ "$available" -gt 0 ]; then
                echo "running"
            else
                echo "not-ready"
            fi
        else
            echo "not-deployed"
        fi
    fi
}

# Helper function to get VLAB resource counts
get_vlab_resources() {
    local vlab_dir="/opt/hedgehog/vlab"

    if [ ! -f "$vlab_dir/wiring.yaml" ]; then
        echo "0 0"
        return
    fi

    # Count switches and VPCs from wiring diagram
    # The wiring.yaml uses Kubernetes-style YAML with kind: Switch and kind: VPC
    # We need to count unique switch and VPC resources

    # Count Switch resources (kind: Switch)
    local switch_count
    switch_count=$(grep -c "^kind: Switch$" "$vlab_dir/wiring.yaml" 2>/dev/null || echo "0")

    # Count VPC resources (kind: VPC)
    # Note: VPCs may not exist in all wiring diagrams
    local vpc_count
    vpc_count=$(grep -c "^kind: VPC$" "$vlab_dir/wiring.yaml" 2>/dev/null || echo "0")

    echo "$switch_count $vpc_count"
}

# Helper function to get current scenario
get_current_scenario() {
    local scenario_file="/var/lib/hedgehog-lab/current-scenario"

    if [ -f "$scenario_file" ]; then
        cat "$scenario_file"
    else
        echo "default"
    fi
}

# status command - show lab initialization status
cmd_status() {
    print_header "Hedgehog Lab Status"
    echo ""

    # Build Type and Initialization Status
    local build_type="standard"
    local init_status="not-initialized"

    if [ -f "$BUILD_TYPE_FILE" ]; then
        build_type=$(cat "$BUILD_TYPE_FILE" | tr -d '[:space:]')
        # Validate and default to standard if invalid
        if [[ ! "$build_type" =~ ^(standard|prewarmed)$ ]]; then
            build_type="standard"
        fi
    fi

    if [ -f "$STAMP_FILE" ]; then
        init_status="initialized"
        print_success "Lab is initialized and ready"

        # Read stamp file info
        if [ -r "$STAMP_FILE" ]; then
            local init_time=$(grep "initialized_at" "$STAMP_FILE" | sed 's/.*: "\([^"]*\)".*/\1/' || echo "unknown")
            echo ""
            print_label "  Initialized" "$init_time"
        fi
    else
        print_warning "Lab is not yet initialized"

        # Check if initialization is in progress
        if [ -f "$STATE_FILE" ]; then
            local status=$(get_state_field "status")
            local current_module=$(get_state_field "current_module")
            init_status="$status"

            echo ""
            print_label "  Status" "$status"
            print_label "  Current Module" "$current_module"

            if [ "$status" = "failed" ]; then
                print_error "Initialization failed. Check logs for details."
            elif [ "$status" = "in_progress" ] || [ "$status" = "running" ]; then
                print_info "Initialization in progress..."
            fi
        else
            print_info "Initialization has not started"
        fi
    fi

    print_label "  Build Type" "$build_type"
    echo ""

    # Credentials status
    print_header "Credentials"
    echo ""

    echo -n "  GHCR Authentication: "
    if [ -f "$GHCR_CREDS_MARKER" ]; then
        print_status_ok
        # Read authentication info if readable
        if [ -r "$GHCR_CREDS_MARKER" ]; then
            local ghcr_user=$(grep "username" "$GHCR_CREDS_MARKER" | sed 's/.*: "\([^"]*\)".*/\1/' || echo "unknown")
            local ghcr_date=$(grep "authenticated_at" "$GHCR_CREDS_MARKER" | sed 's/.*: "\([^"]*\)".*/\1/' || echo "unknown")
            print_label "    Username" "$ghcr_user"
            print_label "    Authenticated" "$ghcr_date"
        fi
    else
        print_status_fail
        echo ""
        print_warning "  GHCR credentials not configured"
        print_info "  Run 'hh-lab setup' to configure credentials"
    fi
    echo ""

    # Services Health
    print_header "Services Health"
    echo ""

    # k3d cluster
    echo -n "  k3d cluster: "
    if command -v k3d &> /dev/null; then
        # Check if k3d-observability cluster exists and servers are running
        # Note: The actual cluster name may be "k3d-observability" or "observability"
        # depending on how it was created. We check for both possibilities.
        local cluster_line
        cluster_line=$(k3d cluster list 2>/dev/null | grep -E "^(k3d-observability|observability)")
        if [ -n "$cluster_line" ]; then
            # Extract servers running/total (second column, format: X/Y)
            local servers_info
            servers_info=$(echo "$cluster_line" | awk '{print $2}')
            local servers_running
            servers_running=$(echo "$servers_info" | cut -d/ -f1)
            local servers_total
            servers_total=$(echo "$servers_info" | cut -d/ -f2)
            # Ensure values default to empty string if parsing fails
            servers_running="${servers_running:-}"
            servers_total="${servers_total:-}"
            # Check if all servers are running (X/X where X > 0)
            if [ -n "$servers_running" ] && [ -n "$servers_total" ] && [ "$servers_running" = "$servers_total" ] && [ "$servers_total" != "0" ]; then
                print_status_ok
            else
                print_status_pending
            fi
        else
            print_status_pending
        fi
    else
        print_status_fail
    fi

    # Kubernetes API
    echo -n "  Kubernetes API: "
    if command -v kubectl &> /dev/null && kubectl cluster-info &> /dev/null; then
        print_status_ok
    else
        print_status_fail
    fi

    # VLAB
    echo -n "  VLAB (hhfab): "
    if command -v hhfab &> /dev/null; then
        local vlab_dir="/opt/hedgehog/vlab"
        if [ -f "$vlab_dir/wiring.yaml" ]; then
            # Check if VLAB VMs are actually running
            if hhfab vlab inspect &> /dev/null; then
                print_status_ok
            else
                print_status_pending
            fi
        else
            print_status_pending
        fi
    else
        print_status_fail
    fi

    # ArgoCD
    echo -n "  ArgoCD: "
    local argocd_status
    argocd_status=$(check_k8s_deployment "argocd" "" "app.kubernetes.io/name=argocd-server")
    case "$argocd_status" in
        running)
            print_status_ok
            ;;
        not-deployed|no-cluster)
            print_status_pending
            ;;
        *)
            print_status_fail
            ;;
    esac

    # Gitea
    echo -n "  Gitea: "
    local gitea_status
    gitea_status=$(check_k8s_deployment "gitea" "" "app.kubernetes.io/name=gitea")
    case "$gitea_status" in
        running)
            print_status_ok
            ;;
        not-deployed|no-cluster)
            print_status_pending
            ;;
        *)
            print_status_fail
            ;;
    esac

    # Grafana
    echo -n "  Grafana: "
    local grafana_status
    grafana_status=$(check_k8s_deployment "monitoring" "" "app.kubernetes.io/name=grafana")
    case "$grafana_status" in
        running)
            print_status_ok
            ;;
        not-deployed|no-cluster)
            print_status_pending
            ;;
        *)
            print_status_fail
            ;;
    esac

    # Prometheus
    echo -n "  Prometheus: "
    local prometheus_status
    prometheus_status=$(check_k8s_deployment "monitoring" "" "app.kubernetes.io/name=prometheus")
    case "$prometheus_status" in
        running)
            print_status_ok
            ;;
        not-deployed|no-cluster)
            print_status_pending
            ;;
        *)
            print_status_fail
            ;;
    esac

    echo ""

    # Resource Counts (only if lab is initialized and VLAB is present)
    if [ "$init_status" = "initialized" ] && [ -f "/opt/hedgehog/vlab/wiring.yaml" ]; then
        print_header "Lab Resources"
        echo ""

        read -r switch_count vpc_count <<< "$(get_vlab_resources)"
        print_label "  Switches" "$switch_count"
        print_label "  VPCs" "$vpc_count"

        # Get node count from k3d if available
        if command -v kubectl &> /dev/null && kubectl cluster-info &> /dev/null; then
            local node_count
            node_count=$(kubectl get nodes --no-headers 2>/dev/null | wc -l || echo "0")
            print_label "  K8s Nodes" "$node_count"
        fi

        echo ""
    fi

    # Current Scenario
    print_header "Current Scenario"
    echo ""
    local current_scenario
    current_scenario=$(get_current_scenario)
    print_label "  Scenario" "$current_scenario"
    echo ""

    # Helpful tips
    print_info "Run '${BOLD}hh-lab logs${NC}' to view initialization logs"
    print_info "Run '${BOLD}hh-lab info${NC}' for detailed system information"
    echo ""
}

# logs command - view initialization logs
cmd_logs() {
    local lines=50
    local follow=false
    local module=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--follow)
                follow=true
                shift
                ;;
            -n|--lines)
                lines="$2"
                shift 2
                ;;
            -m|--module)
                module="$2"
                shift 2
                ;;
            -*)
                print_error "Unknown option: $1"
                echo ""
                echo "Usage: hh-lab logs [-f|--follow] [-n|--lines <num>] [-m|--module <name>] [lines]"
                return 2
                ;;
            *)
                # Positional argument for line count
                if [[ "$1" =~ ^[0-9]+$ ]]; then
                    lines="$1"
                else
                    print_error "Invalid line count: $1 (must be a number)"
                    return 2
                fi
                shift
                ;;
        esac
    done

    # Determine which log to show
    local log_to_show="$LOG_FILE"
    if [ -n "$module" ]; then
        log_to_show="$MODULE_LOG_DIR/${module}.log"
        if [ ! -f "$log_to_show" ]; then
            print_error "Module log not found: $log_to_show"
            echo ""
            print_info "Available modules:"
            if [ -d "$MODULE_LOG_DIR" ]; then
                for log in "$MODULE_LOG_DIR"/*.log; do
                    if [ -f "$log" ]; then
                        echo "  - $(basename "$log" .log)"
                    fi
                done
            else
                echo "  No module logs available"
            fi
            return 1
        fi
    fi

    if [ ! -f "$log_to_show" ]; then
        print_warning "Log file not found: $log_to_show"
        return 1
    fi

    print_header "Hedgehog Lab Logs"
    if [ -n "$module" ]; then
        echo -e "${DIM}Module: $module${NC}"
    fi
    echo -e "${DIM}Log file: $log_to_show${NC}"
    echo -e "${DIM}$(echo "─────────────────────────────────────────────────────────────" | head -c $(tput cols))${NC}"
    echo ""

    if [ "$follow" = true ]; then
        tail -f -n "$lines" "$log_to_show"
    else
        tail -n "$lines" "$log_to_show"
    fi
}

# info command - show detailed system information
cmd_info() {
    print_header "Hedgehog Lab Appliance Information"
    echo ""

    # Version info
    print_header "Version"
    print_label "  hh-lab CLI" "$VERSION"
    if [ -f "$STAMP_FILE" ] && [ -r "$STAMP_FILE" ]; then
        local version=$(grep "version" "$STAMP_FILE" | sed 's/.*: "\([^"]*\)".*/\1/' || echo "unknown")
        print_label "  Appliance" "$version"
    fi
    echo ""

    # Build information
    print_header "Build Information"
    local build_type="standard"
    if [ -f "$BUILD_TYPE_FILE" ]; then
        build_type=$(cat "$BUILD_TYPE_FILE" | tr -d '[:space:]')
        # Validate and default to standard if invalid
        if [[ ! "$build_type" =~ ^(standard|prewarmed)$ ]]; then
            build_type="standard"
        fi
    fi
    print_label "  Build Type" "$build_type"

    if [ -f "$STAMP_FILE" ] && [ -r "$STAMP_FILE" ]; then
        local init_time=$(grep "initialized_at" "$STAMP_FILE" | sed 's/.*: "\([^"]*\)".*/\1/' || echo "unknown")
        print_label "  Initialized" "$init_time"
    fi
    echo ""

    # System information
    print_header "System Information"
    print_label "  Hostname" "$(hostname)"
    print_label "  OS" "$(lsb_release -ds 2>/dev/null || echo "unknown")"
    print_label "  Kernel" "$(uname -r)"
    print_label "  Architecture" "$(uname -m)"
    echo ""

    # Resource usage
    print_header "Resource Usage"
    local mem_total=$(free -h | awk '/^Mem:/ {print $2}')
    local mem_used=$(free -h | awk '/^Mem:/ {print $3}')
    local disk_usage=$(df -h / | awk 'NR==2 {print $3 "/" $2 " (" $5 ")"}')
    print_label "  Memory" "$mem_used / $mem_total"
    print_label "  Disk (/)" "$disk_usage"
    echo ""

    # Installed tools
    print_header "Installed Tools"
    local tools=("docker" "k3d" "kubectl" "helm" "argocd" "hhfab" "k9s" "stern")
    for tool in "${tools[@]}"; do
        if command -v "$tool" &> /dev/null; then
            local version=$($tool version --short 2>/dev/null || $tool version 2>/dev/null | head -1 || echo "installed")
            # Clean up version output
            version=$(echo "$version" | sed 's/^[^0-9]*//' | head -1 | cut -d' ' -f1)
            print_label "  $tool" "$version"
        else
            print_label "  $tool" "${DIM}not installed${NC}"
        fi
    done
    echo ""

    # Kubernetes cluster info
    if command -v kubectl &> /dev/null && kubectl cluster-info &> /dev/null; then
        print_header "Kubernetes Cluster"
        local k8s_version=$(kubectl version --short 2>/dev/null | grep "Server Version" | cut -d' ' -f3 || echo "unknown")
        print_label "  Version" "$k8s_version"

        local node_count=$(kubectl get nodes --no-headers 2>/dev/null | wc -l || echo "0")
        print_label "  Nodes" "$node_count"

        local ns_count=$(kubectl get namespaces --no-headers 2>/dev/null | wc -l || echo "0")
        print_label "  Namespaces" "$ns_count"

        echo ""
    fi

    # File locations
    print_header "File Locations"
    print_label "  State file" "$STATE_FILE"
    print_label "  Log file" "$LOG_FILE"
    print_label "  Module logs" "$MODULE_LOG_DIR"
    echo ""
}

# setup command - configure GHCR credentials and start lab initialization
cmd_setup() {
    print_header "Hedgehog Lab Setup"
    echo ""

    # Ensure log directory and file exist
    mkdir -p "$(dirname "$SETUP_LOG")" 2>/dev/null || true
    touch "$SETUP_LOG" 2>/dev/null || true

    # Check if already set up
    if [ -f "$GHCR_CREDS_MARKER" ]; then
        print_warning "GHCR credentials are already configured"
        echo ""
        read -r -p "Do you want to re-configure credentials? [y/N] " response
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            echo "Setup cancelled"
            return 0
        fi
        # Remove old marker
        sudo rm -f "$GHCR_CREDS_MARKER" 2>/dev/null || true
    fi

    # Display instructions
    cat <<EOF
This setup wizard will configure your lab environment with GitHub Container
Registry (GHCR) credentials required to pull Hedgehog container images.

You will need:
  - A GitHub username
  - A GitHub Personal Access Token (PAT) with 'read:packages' scope

To create a PAT:
  1. Go to https://github.com/settings/tokens
  2. Click "Generate new token" (classic)
  3. Give it a descriptive name (e.g., "Hedgehog Lab")
  4. Select the 'read:packages' scope
  5. Click "Generate token" and copy it immediately

EOF

    # Prompt for GHCR username
    read -r -p "Enter your GitHub username: " ghcr_username
    if [ -z "$ghcr_username" ]; then
        print_error "Username cannot be empty"
        return 1
    fi

    # Prompt for GHCR token (hide input)
    echo ""
    read -r -s -p "Enter your GitHub Personal Access Token: " ghcr_token
    echo ""

    if [ -z "$ghcr_token" ]; then
        print_error "Token cannot be empty"
        return 1
    fi

    # Perform docker login
    echo ""
    print_info "Authenticating with ghcr.io..."

    # Try docker login and capture output
    if echo "$ghcr_token" | sudo docker login ghcr.io -u "$ghcr_username" --password-stdin >> "$SETUP_LOG" 2>&1; then
        print_success "Successfully authenticated with ghcr.io"

        # Create marker file
        sudo mkdir -p "$(dirname "$GHCR_CREDS_MARKER")"
        sudo tee "$GHCR_CREDS_MARKER" > /dev/null <<MARKER_EOF
{
  "authenticated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "username": "$ghcr_username",
  "registry": "ghcr.io"
}
MARKER_EOF

        # Unset variables containing sensitive data
        ghcr_token=""
        unset ghcr_token

        echo ""
        print_info "Credentials have been configured and the token has been securely discarded"
        print_info "You can now start the lab initialization"
        echo ""

        # Ask if user wants to start initialization now
        read -r -p "Would you like to start lab initialization now? [Y/n] " start_now
        if [[ ! "$start_now" =~ ^[Nn]$ ]]; then
            print_info "Starting lab initialization..."
            echo ""

            # Start the hedgehog-lab-init service
            if sudo systemctl start hedgehog-lab-init.service; then
                print_success "Lab initialization started"
                echo ""
                print_info "You can monitor progress with:"
                echo "  - hh-lab status"
                echo "  - hh-lab logs -f"
                echo "  - hh-lab monitor"
                echo ""
            else
                print_error "Failed to start lab initialization"
                print_info "Try manually with: sudo systemctl start hedgehog-lab-init.service"
                return 1
            fi
        else
            echo ""
            print_info "Lab initialization not started"
            print_info "Start it manually with: sudo systemctl start hedgehog-lab-init.service"
            echo ""
        fi
    else
        print_error "Authentication failed"
        print_info "Please check your username and token"
        print_info "See logs at: $SETUP_LOG"

        # Unset variables containing sensitive data
        ghcr_token=""
        unset ghcr_token

        return 1
    fi

    return 0
}

# help command - show usage information
cmd_help() {
    cat <<EOF
${BOLD}NAME${NC}
    hh-lab - Hedgehog Lab Appliance management tool

${BOLD}SYNOPSIS${NC}
    ${BOLD}hh-lab${NC} ${CYAN}<command>${NC} [options]

${BOLD}DESCRIPTION${NC}
    Command-line tool for managing and monitoring the Hedgehog Lab Appliance.
    Provides status checking, log viewing, and system information commands.

${BOLD}COMMANDS${NC}
    ${BOLD}setup${NC}
        Configure GHCR credentials and initialize the lab

        This command prompts for GitHub Container Registry credentials,
        performs 'docker login ghcr.io', and optionally starts the lab
        initialization process.

        IMPORTANT: Run this command FIRST on a new appliance before
        using any other lab features. The credentials are required to
        pull Hedgehog container images.

        The setup wizard will:
        - Prompt for GitHub username
        - Prompt for GitHub Personal Access Token (PAT)
        - Authenticate with ghcr.io
        - Create a credentials marker file
        - Optionally start lab initialization

        Tokens are never stored permanently and are wiped from memory
        after successful authentication.

    ${BOLD}status${NC}
        Display comprehensive lab status

        Shows:
        - Build type (standard/prewarmed)
        - Initialization status
        - Credentials status (whether GHCR login has been performed)
        - Service health (k3d, VLAB, ArgoCD, Gitea, Grafana, Prometheus)
        - Resource counts (switches, VPCs, K8s nodes)
        - Current scenario

        All status indicators are color-coded for easy visibility.

    ${BOLD}logs${NC} [options] [lines]
        View initialization logs

        ${BOLD}Options:${NC}
            -f, --follow          Follow log output (like tail -f)
            -n, --lines <num>     Number of lines to show (default: 50)
            -m, --module <name>   Show logs for specific module

        ${BOLD}Examples:${NC}
            hh-lab logs                    # Show last 50 lines
            hh-lab logs 100                # Show last 100 lines
            hh-lab logs -f                 # Follow logs in real-time
            hh-lab logs -m k3d-init        # Show k3d module logs
            hh-lab logs -m vlab-init -n 200  # Show 200 lines of vlab logs

    ${BOLD}info${NC}
        Display detailed system information

        Shows version info, build information, system resources, installed
        tools, Kubernetes cluster details, and file locations.

    ${BOLD}monitor${NC}
        Monitor initialization progress in real-time with visual progress bar

    ${BOLD}help${NC}
        Display this help message

    ${BOLD}version${NC}
        Display version information

${BOLD}FILES${NC}
    /var/lib/hedgehog-lab/state.json
        Current initialization state

    /var/lib/hedgehog-lab/initialized
        Stamp file indicating successful initialization

    /var/log/hedgehog-lab-init.log
        Main initialization log

    /var/log/hedgehog-lab/modules/
        Module-specific logs

${BOLD}EXAMPLES${NC}
    # Check if lab is ready
    hh-lab status

    # View recent initialization logs
    hh-lab logs

    # Follow logs in real-time
    hh-lab logs --follow

    # Show system information
    hh-lab info

    # View specific module logs
    hh-lab logs -m k3d-observability-init

    # Monitor initialization progress in real-time
    hh-lab monitor

${BOLD}EXIT STATUS${NC}
    0    Success
    1    General error
    2    Invalid command or arguments

${BOLD}VERSION${NC}
    hh-lab version $VERSION

${BOLD}AUTHOR${NC}
    Hedgehog Lab Appliance Project
    https://github.com/afewell-hh/labapp

${BOLD}SEE ALSO${NC}
    hedgehog-lab-orchestrator(1), hhfab(1), k3d(1), kubectl(1)

EOF
}

# version command - show version
cmd_version() {
    echo "hh-lab version $VERSION"
}

# monitor command - show initialization progress UI
cmd_monitor() {
    # Check if readiness UI is available
    if ! command -v hedgehog-lab-readiness-ui &> /dev/null; then
        print_error "hedgehog-lab-readiness-ui command not found"
        echo ""
        echo "The readiness UI tool should be installed at /usr/local/bin/hedgehog-lab-readiness-ui"
        exit 1
    fi

    # Run the readiness UI in monitor mode
    hedgehog-lab-readiness-ui monitor
}

# Main command dispatcher
main() {
    # Check if any arguments provided
    if [ $# -eq 0 ]; then
        cmd_help
        exit 0
    fi

    # Get command
    local command="$1"
    shift

    # Dispatch to command handler
    case "$command" in
        setup)
            cmd_setup "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        logs)
            cmd_logs "$@"
            ;;
        info)
            cmd_info "$@"
            ;;
        monitor)
            cmd_monitor "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        version|--version|-v)
            cmd_version
            ;;
        *)
            print_error "Unknown command: $command"
            echo ""
            echo "Run '${BOLD}hh-lab help${NC}' for usage information"
            exit 2
            ;;
    esac
}

# Run main function
main "$@"
