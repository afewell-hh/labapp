#!/bin/bash
# hedgehog-lab-orchestrator
# Main orchestrator script for Hedgehog Lab Appliance initialization
# Runs on first boot to set up the lab environment

set -euo pipefail

# Configuration
LOCK_FILE="/var/lock/hedgehog-lab-init.lock"
LOG_FILE="/var/log/hedgehog-lab-init.log"
STAMP_FILE="/var/lib/hedgehog-lab/initialized"
BUILD_TYPE_FILE="/etc/hedgehog-lab/build-type"
STATE_FILE="/var/lib/hedgehog-lab/state.json"

# Global state tracking
INITIALIZATION_FAILED=false
CURRENT_STEP=""
STEPS_COMPLETED=()

# Logging functions
log() {
    local level="${1:-INFO}"
    shift
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$level] $*" | tee -a "$LOG_FILE"
}

log_info() {
    log "INFO" "$@"
}

log_warn() {
    log "WARN" "$@"
}

log_error() {
    log "ERROR" "$@"
}

log_debug() {
    log "DEBUG" "$@"
}

# Error handling with rollback capability
error() {
    log_error "$*"
    INITIALIZATION_FAILED=true
    cleanup_on_error
    exit 1
}

# Save current state to disk
save_state() {
    local status="$1"
    local current_module="${2:-none}"

    # Build steps_completed JSON array, handling empty array case
    local steps_json="[]"
    if [ ${#STEPS_COMPLETED[@]} -gt 0 ]; then
        steps_json="[$(printf '"%s",' "${STEPS_COMPLETED[@]}" | sed 's/,$//')]"
    fi

    cat > "$STATE_FILE" <<EOF
{
  "status": "$status",
  "current_module": "$current_module",
  "build_type": "${BUILD_TYPE:-unknown}",
  "started_at": "${START_TIME:-unknown}",
  "last_updated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "steps_completed": ${steps_json},
  "failed": ${INITIALIZATION_FAILED}
}
EOF
}

# Cleanup function for error conditions
cleanup_on_error() {
    log_warn "Initialization failed. Performing cleanup..."
    save_state "failed" "$CURRENT_STEP"

    # Don't remove lock file here - let trap handle it
    # This allows for inspection of what went wrong

    log_error "Initialization incomplete. Check logs at $LOG_FILE"
    log_error "State saved to $STATE_FILE for debugging"
}

# Create state and log directories early (before any save_state calls)
mkdir -p /var/lib/hedgehog-lab
mkdir -p /var/log/hedgehog-lab
mkdir -p /var/log/hedgehog-lab/modules

# Check if already initialized
if [ -f "$STAMP_FILE" ]; then
    log_info "Lab already initialized. Exiting."
    exit 0
fi

# Acquire lock to prevent concurrent runs
if [ -f "$LOCK_FILE" ]; then
    # Check if lock is stale (older than 2 hours)
    if [ -n "$(find "$LOCK_FILE" -mmin +120 2>/dev/null)" ]; then
        log_warn "Found stale lock file (>2 hours old). Removing it."
        rm -f "$LOCK_FILE"
    else
        log_warn "Another initialization is in progress. Exiting."
        exit 0
    fi
fi

# Create lock file with PID
echo $$ > "$LOCK_FILE"
trap "rm -f $LOCK_FILE" EXIT

# Record start time
START_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)

# Initialize state
save_state "initializing" "startup"

# Start initialization
log_info "=================================================="
log_info "Hedgehog Lab Appliance Initialization Starting..."
log_info "=================================================="

# Detect build type
BUILD_TYPE="standard"
if [ -f "$BUILD_TYPE_FILE" ]; then
    BUILD_TYPE=$(cat "$BUILD_TYPE_FILE" | tr -d '[:space:]')
fi
log_info "Build type: $BUILD_TYPE"

# Validate build type
if [[ ! "$BUILD_TYPE" =~ ^(standard|prewarmed)$ ]]; then
    error "Invalid build type: $BUILD_TYPE (must be 'standard' or 'prewarmed')"
fi

# Helper function to execute a step with error handling
execute_step() {
    local step_name="$1"
    local step_number="$2"
    local total_steps="$3"
    shift 3
    local step_function="$@"

    CURRENT_STEP="$step_name"
    log_info ""
    log_info "Step $step_number/$total_steps: $step_name..."
    save_state "running" "$step_name"

    # Execute the step function
    if eval "$step_function"; then
        STEPS_COMPLETED+=("$step_name")
        log_info "✓ $step_name completed successfully"
        save_state "running" "$step_name"
        return 0
    else
        log_error "✗ $step_name failed"
        return 1
    fi
}

# Display banner
cat <<'EOF'
  _   _          _            _                   _           _
 | | | | ___  __| | __ _  ___| |__   ___   __ _  | |     __ _| |__
 | |_| |/ _ \/ _` |/ _` |/ _ \ '_ \ / _ \ / _` | | |    / _` | '_ \
 |  _  |  __/ (_| | (_| |  __/ | | | (_) | (_| | | |___| (_| | |_) |
 |_| |_|\___|\__,_|\__, |\___|_| |_|\___/ \__, | |_____|\__,_|_.__/
                   |___/                  |___/
EOF

log_info ""
log_info "Initializing Hedgehog Lab Appliance..."
log_info ""

# Define initialization steps as functions
wait_for_network() {
    local module_log="/var/log/hedgehog-lab/modules/network.log"

    log_info "Waiting for network connectivity..." | tee -a "$module_log"

    # Wait for network with timeout (max 5 minutes)
    local NETWORK_TIMEOUT=300
    local NETWORK_ELAPSED=0
    local NETWORK_READY=false

    while [ $NETWORK_ELAPSED -lt $NETWORK_TIMEOUT ]; do
        # Try multiple connectivity checks
        if ping -c 1 -W 1 8.8.8.8 &>/dev/null || \
           ping -c 1 -W 1 1.1.1.1 &>/dev/null || \
           systemctl is-active --quiet network-online.target; then
            NETWORK_READY=true
            break
        fi
        sleep 2
        NETWORK_ELAPSED=$((NETWORK_ELAPSED + 2))
    done

    if [ "$NETWORK_READY" = true ]; then
        log_info "Network is ready" | tee -a "$module_log"
        return 0
    else
        log_warn "Network connectivity check timed out after ${NETWORK_TIMEOUT}s" | tee -a "$module_log"
        log_warn "Proceeding with initialization (some steps may fail without network)" | tee -a "$module_log"
        # Don't fail here - return success and let later steps handle network issues
        return 0
    fi
}

init_k3d_cluster() {
    local module_log="/var/log/hedgehog-lab/modules/k3d.log"
    log_info "k3d initialization will be implemented in future sprint" | tee -a "$module_log"
    return 0
}

init_vlab() {
    local module_log="/var/log/hedgehog-lab/modules/vlab.log"
    local vlab_script="/usr/local/bin/hedgehog-vlab-init"

    log_info "Initializing Hedgehog VLAB..." | tee -a "$module_log"

    # Check if VLAB init script exists
    if [ ! -f "$vlab_script" ]; then
        log_error "VLAB initialization script not found at $vlab_script" | tee -a "$module_log"
        return 1
    fi

    # Set environment variables for the VLAB module
    export VLAB_WORK_DIR="/opt/hedgehog/vlab"
    export VLAB_TIMEOUT="1800"  # 30 minutes
    export LOG_FILE="$module_log"

    # Execute VLAB initialization script
    if "$vlab_script"; then
        log_info "VLAB initialization completed successfully" | tee -a "$module_log"
        return 0
    else
        log_error "VLAB initialization failed" | tee -a "$module_log"
        return 1
    fi
}

deploy_gitops_stack() {
    local module_log="/var/log/hedgehog-lab/modules/gitops.log"
    log_info "GitOps stack deployment will be implemented in future sprint" | tee -a "$module_log"
    return 0
}

deploy_observability_stack() {
    local module_log="/var/log/hedgehog-lab/modules/observability.log"
    log_info "Observability stack deployment will be implemented in future sprint" | tee -a "$module_log"
    return 0
}

start_services() {
    local module_log="/var/log/hedgehog-lab/modules/services.log"
    log_info "Service startup will be implemented in future sprint" | tee -a "$module_log"
    return 0
}

# Execute initialization based on build type
if [ "$BUILD_TYPE" = "standard" ]; then
    log_info "Standard build detected - performing full initialization"

    TOTAL_STEPS=5
    execute_step "Wait for network" 1 $TOTAL_STEPS wait_for_network || error "Network check failed"
    execute_step "Initialize k3d cluster" 2 $TOTAL_STEPS init_k3d_cluster || error "k3d initialization failed"
    execute_step "Initialize VLAB" 3 $TOTAL_STEPS init_vlab || error "VLAB initialization failed"
    execute_step "Deploy GitOps stack" 4 $TOTAL_STEPS deploy_gitops_stack || error "GitOps deployment failed"
    execute_step "Deploy observability stack" 5 $TOTAL_STEPS deploy_observability_stack || error "Observability deployment failed"

else
    log_info "Pre-warmed build detected - starting services only"

    TOTAL_STEPS=2
    execute_step "Wait for network" 1 $TOTAL_STEPS wait_for_network || error "Network check failed"
    execute_step "Start services" 2 $TOTAL_STEPS start_services || error "Service startup failed"
fi

# Mark as initialized
mkdir -p $(dirname "$STAMP_FILE")
cat > "$STAMP_FILE" <<EOF
{
  "initialized_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "build_type": "$BUILD_TYPE",
  "version": "0.1.0"
}
EOF

# Save final state
save_state "completed" "finalized"

log_info ""
log_info "=================================================="
log_info "Hedgehog Lab Appliance Initialization Complete!"
log_info "=================================================="
log_info ""
log_info "Build type: $BUILD_TYPE"
log_info "Steps completed: ${#STEPS_COMPLETED[@]}/$TOTAL_STEPS"
log_info "Initialization time: Started at $START_TIME"
log_info ""
log_info "Lab is ready for use."
log_info "Logs: $LOG_FILE"
log_info "State: $STATE_FILE"
log_info ""
log_info "Next steps:"
log_info "  - Run 'hh-lab status' to check service status (when implemented)"
log_info "  - Access services via their respective ports"
log_info ""

exit 0
