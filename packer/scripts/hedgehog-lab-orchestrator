#!/bin/bash
# hedgehog-lab-orchestrator
# Main orchestrator script for Hedgehog Lab Appliance initialization
# Runs on first boot to set up the lab environment

set -euo pipefail

# Configuration
LOCK_FILE="/var/lock/hedgehog-lab-init.lock"
LOG_FILE="/var/log/hedgehog-lab-init.log"
STAMP_FILE="/var/lib/hedgehog-lab/initialized"
BUILD_TYPE_FILE="/etc/hedgehog-lab/build-type"
STATE_FILE="/var/lib/hedgehog-lab/state.json"

# Global state tracking
INITIALIZATION_FAILED=false
CURRENT_STEP=""
STEPS_COMPLETED=()

# Logging functions
log() {
    local level="${1:-INFO}"
    shift
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$level] $*" | tee -a "$LOG_FILE"
}

log_info() {
    log "INFO" "$@"
}

log_warn() {
    log "WARN" "$@"
}

log_error() {
    log "ERROR" "$@"
}

log_debug() {
    log "DEBUG" "$@"
}

# Error handling with rollback capability
error() {
    log_error "$*"
    INITIALIZATION_FAILED=true
    cleanup_on_error
    exit 1
}

# Save current state to disk
save_state() {
    local status="$1"
    local current_module="${2:-none}"

    # Build steps_completed JSON array, handling empty array case
    local steps_json="[]"
    if [ ${#STEPS_COMPLETED[@]} -gt 0 ]; then
        steps_json="[$(printf '"%s",' "${STEPS_COMPLETED[@]}" | sed 's/,$//')]"
    fi

    cat > "$STATE_FILE" <<EOF
{
  "status": "$status",
  "current_module": "$current_module",
  "build_type": "${BUILD_TYPE:-unknown}",
  "started_at": "${START_TIME:-unknown}",
  "last_updated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "steps_completed": ${steps_json},
  "failed": ${INITIALIZATION_FAILED}
}
EOF
}

# Cleanup function for error conditions
cleanup_on_error() {
    log_warn "Initialization failed. Performing cleanup..."
    save_state "failed" "$CURRENT_STEP"

    # Don't remove lock file here - let trap handle it
    # This allows for inspection of what went wrong

    log_error "Initialization incomplete. Check logs at $LOG_FILE"
    log_error "State saved to $STATE_FILE for debugging"
}

# Create state and log directories early (before any save_state calls)
mkdir -p /var/lib/hedgehog-lab
mkdir -p /var/log/hedgehog-lab
mkdir -p /var/log/hedgehog-lab/modules

# Check if already initialized
if [ -f "$STAMP_FILE" ]; then
    log_info "Lab already initialized. Exiting."
    exit 0
fi

# Acquire lock to prevent concurrent runs
if [ -f "$LOCK_FILE" ]; then
    # Check if lock is stale (older than 2 hours)
    if [ -n "$(find "$LOCK_FILE" -mmin +120 2>/dev/null)" ]; then
        log_warn "Found stale lock file (>2 hours old). Removing it."
        rm -f "$LOCK_FILE"
    else
        log_warn "Another initialization is in progress. Exiting."
        exit 0
    fi
fi

# Create lock file with PID
echo $$ > "$LOCK_FILE"
trap "rm -f $LOCK_FILE" EXIT

# Record start time
START_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)

# Initialize state
save_state "initializing" "startup"

# Start initialization
log_info "=================================================="
log_info "Hedgehog Lab Appliance Initialization Starting..."
log_info "=================================================="

# Detect build type
BUILD_TYPE="standard"
if [ -f "$BUILD_TYPE_FILE" ]; then
    BUILD_TYPE=$(cat "$BUILD_TYPE_FILE" | tr -d '[:space:]')
fi

# Validate build type and default to standard if invalid
if [[ ! "$BUILD_TYPE" =~ ^(standard|prewarmed)$ ]]; then
    if [ -f "$BUILD_TYPE_FILE" ]; then
        log_warn "Invalid build type in $BUILD_TYPE_FILE: '$BUILD_TYPE' (must be 'standard' or 'prewarmed')"
        log_warn "Defaulting to 'standard' build type"
    fi
    BUILD_TYPE="standard"
fi

log_info "Build type: $BUILD_TYPE"

# Helper function to execute a step with error handling
execute_step() {
    local step_name="$1"
    local step_number="$2"
    local total_steps="$3"
    shift 3
    local step_function="$@"

    CURRENT_STEP="$step_name"
    log_info ""
    log_info "Step $step_number/$total_steps: $step_name..."
    save_state "running" "$step_name"

    # Execute the step function
    if eval "$step_function"; then
        STEPS_COMPLETED+=("$step_name")
        log_info "✓ $step_name completed successfully"
        save_state "running" "$step_name"
        return 0
    else
        log_error "✗ $step_name failed"
        return 1
    fi
}

# Display banner
cat <<'EOF'
  _   _          _            _                   _           _
 | | | | ___  __| | __ _  ___| |__   ___   __ _  | |     __ _| |__
 | |_| |/ _ \/ _` |/ _` |/ _ \ '_ \ / _ \ / _` | | |    / _` | '_ \
 |  _  |  __/ (_| | (_| |  __/ | | | (_) | (_| | | |___| (_| | |_) |
 |_| |_|\___|\__,_|\__, |\___|_| |_|\___/ \__, | |_____|\__,_|_.__/
                   |___/                  |___/
EOF

log_info ""
log_info "Initializing Hedgehog Lab Appliance..."
log_info ""

# Define initialization steps as functions
wait_for_network() {
    local module_log="/var/log/hedgehog-lab/modules/network.log"

    # Ensure log file exists with correct ownership
    touch "$module_log"
    chown hhlab:hhlab "$module_log"

    log_info "Waiting for network connectivity..." | tee -a "$module_log"

    # Wait for network with timeout (max 5 minutes)
    local NETWORK_TIMEOUT=300
    local NETWORK_ELAPSED=0
    local NETWORK_READY=false

    while [ $NETWORK_ELAPSED -lt $NETWORK_TIMEOUT ]; do
        # Try multiple connectivity checks
        if ping -c 1 -W 1 8.8.8.8 &>/dev/null || \
           ping -c 1 -W 1 1.1.1.1 &>/dev/null || \
           systemctl is-active --quiet network-online.target; then
            NETWORK_READY=true
            break
        fi
        sleep 2
        NETWORK_ELAPSED=$((NETWORK_ELAPSED + 2))
    done

    if [ "$NETWORK_READY" = true ]; then
        log_info "Network is ready" | tee -a "$module_log"
        return 0
    else
        log_warn "Network connectivity check timed out after ${NETWORK_TIMEOUT}s" | tee -a "$module_log"
        log_warn "Proceeding with initialization (some steps may fail without network)" | tee -a "$module_log"
        # Don't fail here - return success and let later steps handle network issues
        return 0
    fi
}

install_hhfab() {
    local module_log="/var/log/hedgehog-lab/modules/hhfab-install.log"

    # Ensure log file exists with correct ownership
    touch "$module_log"
    chown hhlab:hhlab "$module_log"

    log_info "Installing hhfab CLI..." | tee -a "$module_log"

    # Check if hhfab is already installed
    if command -v hhfab &> /dev/null; then
        local hhfab_version
        hhfab_version=$(hhfab --version 2>&1 | grep -oP 'v\d+\.\d+\.\d+' || echo "unknown")
        log_info "hhfab is already installed (version: $hhfab_version)" | tee -a "$module_log"
        return 0
    fi

    # Check if GHCR credentials are configured
    if [ ! -f "/var/lib/hedgehog-lab/ghcr-authenticated" ]; then
        log_error "GHCR credentials not configured. Please run 'hh-lab setup' first." | tee -a "$module_log"
        return 1
    fi

    log_info "GHCR credentials found. Proceeding with installation..." | tee -a "$module_log"

    # Download and run the hhfab installer
    # The installer uses 'oras' which will automatically use the Docker credentials from ~/.docker/config.json
    log_info "Downloading hhfab installer from https://i.hhdev.io/hhfab..." | tee -a "$module_log"

    if curl -fsSL https://i.hhdev.io/hhfab | bash >> "$module_log" 2>&1; then
        log_info "hhfab installer completed successfully" | tee -a "$module_log"

        # Verify installation
        if command -v hhfab &> /dev/null; then
            local hhfab_version
            hhfab_version=$(hhfab --version 2>&1 | grep -oP 'v\d+\.\d+\.\d+' || echo "unknown")
            log_info "hhfab successfully installed (version: $hhfab_version)" | tee -a "$module_log"
            return 0
        else
            log_error "hhfab installer ran but command not found" | tee -a "$module_log"
            return 1
        fi
    else
        log_error "hhfab installer failed. See $module_log for details" | tee -a "$module_log"
        return 1
    fi
}

init_k3d_cluster() {
    local module_log="/var/log/hedgehog-lab/modules/k3d.log"
    local k3d_script="/usr/local/bin/hedgehog-k3d-init"

    # Ensure log file exists with correct ownership
    touch "$module_log"
    chown hhlab:hhlab "$module_log"

    log_info "Initializing k3d observability cluster..." | tee -a "$module_log"

    # Check if k3d init script exists
    if [ ! -f "$k3d_script" ]; then
        log_error "k3d initialization script not found at $k3d_script" | tee -a "$module_log"
        return 1
    fi

    # Set environment variables for the k3d module
    export K3D_CLUSTER_NAME="k3d-observability"
    export K3D_TIMEOUT="900"  # 15 minutes
    export LOG_FILE="$module_log"

    # Execute k3d initialization script
    if "$k3d_script"; then
        log_info "k3d cluster initialization completed successfully" | tee -a "$module_log"
        return 0
    else
        log_error "k3d cluster initialization failed" | tee -a "$module_log"
        return 1
    fi
}

init_vlab() {
    local module_log="/var/log/hedgehog-lab/modules/vlab.log"
    local service_name="hhfab-vlab.service"
    local max_wait=1800  # 30 minutes
    local check_interval=10

    # Ensure log file exists with correct ownership before writing
    # The systemd service runs as hhlab, so it needs write access
    touch "$module_log"
    chown hhlab:hhlab "$module_log"

    log_info "Initializing Hedgehog VLAB via systemd service..." | tee -a "$module_log"

    # Pre-check: if VLAB already initialized, skip service start
    if [ -f "/var/lib/hedgehog-lab/vlab-initialized" ]; then
        log_info "VLAB already initialized (state marker exists), skipping" | tee -a "$module_log"
        return 0
    fi

    # Check if systemd service exists
    if ! systemctl list-unit-files | grep -q "^${service_name}"; then
        log_error "VLAB systemd service not found: $service_name" | tee -a "$module_log"
        return 1
    fi

    # Start the hhfab-vlab service
    log_info "Starting $service_name..." | tee -a "$module_log"
    if ! systemctl start "$service_name"; then
        log_error "Failed to start $service_name" | tee -a "$module_log"
        return 1
    fi

    log_info "VLAB service started. Waiting for completion (max ${max_wait}s)..." | tee -a "$module_log"

    # Wait for the service to complete
    local elapsed=0
    while [ $elapsed -lt $max_wait ]; do
        # Check service status
        local service_state
        service_state=$(systemctl show -p ActiveState --value "$service_name")
        local service_result
        service_result=$(systemctl show -p Result --value "$service_name")

        # Service completed successfully
        if [ "$service_state" = "active" ] && [ "$service_result" = "success" ]; then
            log_info "VLAB service completed successfully" | tee -a "$module_log"

            # Verify the state marker was created
            if [ -f "/var/lib/hedgehog-lab/vlab-initialized" ]; then
                log_info "VLAB initialization state marker confirmed" | tee -a "$module_log"
                return 0
            else
                log_warn "VLAB service succeeded but state marker not found" | tee -a "$module_log"
                # Continue anyway as service reported success
                return 0
            fi
        # Service was skipped due to ConditionPathExists (already initialized)
        elif [ "$service_state" = "inactive" ] && [ "$service_result" = "condition" ]; then
            log_info "VLAB service skipped (condition not met - already initialized)" | tee -a "$module_log"
            return 0
        # Service failed
        elif [ "$service_state" = "failed" ]; then
            log_error "VLAB service failed" | tee -a "$module_log"
            log_error "Check service logs: journalctl -u $service_name" | tee -a "$module_log"
            # Display last 20 lines of service log
            log_error "Last 20 lines of service output:" | tee -a "$module_log"
            journalctl -u "$service_name" --no-pager -n 20 | while IFS= read -r line; do
                log_error "  $line" | tee -a "$module_log"
            done
            return 1
        fi

        # Still running, wait and check again
        sleep "$check_interval"
        elapsed=$((elapsed + check_interval))

        # Log progress every minute
        if [ $((elapsed % 60)) -eq 0 ]; then
            log_info "Still waiting for VLAB... (${elapsed}s elapsed)" | tee -a "$module_log"
        fi
    done

    # Timeout reached
    log_error "VLAB initialization timed out after ${max_wait}s" | tee -a "$module_log"
    log_error "Service state: $(systemctl show -p ActiveState --value $service_name)" | tee -a "$module_log"
    log_error "Check service logs: journalctl -u $service_name" | tee -a "$module_log"
    return 1
}

deploy_gitops_stack() {
    local module_log="/var/log/hedgehog-lab/modules/gitops.log"
    local gitops_script="/usr/local/bin/hedgehog-gitops-init"

    # Ensure log file exists with correct ownership
    touch "$module_log"
    chown hhlab:hhlab "$module_log"

    log_info "Deploying GitOps stack..." | tee -a "$module_log"

    # Check if GitOps init script exists
    if [ ! -f "$gitops_script" ]; then
        log_error "GitOps initialization script not found at $gitops_script" | tee -a "$module_log"
        return 1
    fi

    # Set environment variables for the GitOps module
    export LOG_FILE="$module_log"

    # Execute GitOps initialization script
    if "$gitops_script"; then
        log_info "GitOps stack deployment completed successfully" | tee -a "$module_log"
        return 0
    else
        log_error "GitOps stack deployment failed" | tee -a "$module_log"
        return 1
    fi
}

deploy_argocd_app() {
    local module_log="/var/log/hedgehog-lab/modules/argocd-app.log"
    local argocd_app_script="/usr/local/bin/hedgehog-argocd-app-init"

    # Ensure log file exists with correct ownership
    touch "$module_log"
    chown hhlab:hhlab "$module_log"

    log_info "Deploying ArgoCD Application..." | tee -a "$module_log"

    # Check if ArgoCD app init script exists
    if [ ! -f "$argocd_app_script" ]; then
        log_error "ArgoCD Application initialization script not found at $argocd_app_script" | tee -a "$module_log"
        return 1
    fi

    # Set environment variables for the ArgoCD app module
    export LOG_FILE="$module_log"

    # Execute ArgoCD Application initialization script
    if "$argocd_app_script"; then
        log_info "ArgoCD Application deployment completed successfully" | tee -a "$module_log"
        return 0
    else
        log_error "ArgoCD Application deployment failed" | tee -a "$module_log"
        return 1
    fi
}

deploy_observability_stack() {
    local module_log="/var/log/hedgehog-lab/modules/prometheus-scrape.log"
    local prometheus_scrape_script="/usr/local/bin/hedgehog-prometheus-scrape"

    # Ensure log file exists with correct ownership
    touch "$module_log"
    chown hhlab:hhlab "$module_log"

    log_info "Deploying observability stack (Prometheus scrape config)..." | tee -a "$module_log"

    # Check if Prometheus scrape script exists
    if [ ! -f "$prometheus_scrape_script" ]; then
        log_error "Prometheus scrape script not found at $prometheus_scrape_script" | tee -a "$module_log"
        return 1
    fi

    # Set environment variables for the Prometheus scrape module
    export LOG_FILE="$module_log"

    # Execute Prometheus scrape configuration script
    if "$prometheus_scrape_script"; then
        log_info "Observability stack deployment completed successfully" | tee -a "$module_log"
        return 0
    else
        log_error "Observability stack deployment failed" | tee -a "$module_log"
        return 1
    fi
}

start_services() {
    local module_log="/var/log/hedgehog-lab/modules/services.log"
    log_info "Service startup will be implemented in future sprint" | tee -a "$module_log"
    return 0
}

# Execute initialization based on build type
if [ "$BUILD_TYPE" = "standard" ]; then
    log_info "Standard build detected - performing full initialization"
    log_info "IMPORTANT: VLAB must complete before EMC/GitOps initialization"
    log_info ""

    TOTAL_STEPS=8
    execute_step "Wait for network" 1 $TOTAL_STEPS wait_for_network || error "Network check failed"
    # Install hhfab CLI (Bug #14) - required before VLAB initialization
    execute_step "Install hhfab CLI" 2 $TOTAL_STEPS install_hhfab || error "hhfab installation failed"
    # VLAB MUST initialize next (Issue #73) - it provides the controller interface for EMC
    execute_step "Initialize VLAB" 3 $TOTAL_STEPS init_vlab || error "VLAB initialization failed"
    # k3d cluster can only start after VLAB is ready to provide host-facing connectivity
    execute_step "Initialize k3d cluster" 4 $TOTAL_STEPS init_k3d_cluster || error "k3d initialization failed"
    # Seed GitOps repository in Gitea with student/hedgehog-config
    execute_step "Seed GitOps repository" 5 $TOTAL_STEPS deploy_gitops_stack || error "GitOps deployment failed"
    # Create ArgoCD Application to sync repo to Hedgehog controller
    execute_step "Deploy ArgoCD Application" 6 $TOTAL_STEPS deploy_argocd_app || error "ArgoCD Application deployment failed"
    # Configure Prometheus to scrape Hedgehog fabric-proxy metrics
    execute_step "Configure observability" 7 $TOTAL_STEPS deploy_observability_stack || error "Observability deployment failed"
    # Note: Grafana dashboard import will be added when JSON files are available (Issue #74)
    execute_step "Finalize services" 8 $TOTAL_STEPS start_services || error "Service finalization failed"

else
    log_info "Pre-warmed build detected - starting services only"

    TOTAL_STEPS=2
    execute_step "Wait for network" 1 $TOTAL_STEPS wait_for_network || error "Network check failed"
    execute_step "Start services" 2 $TOTAL_STEPS start_services || error "Service startup failed"
fi

# Mark as initialized
mkdir -p $(dirname "$STAMP_FILE")
cat > "$STAMP_FILE" <<EOF
{
  "initialized_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "build_type": "$BUILD_TYPE",
  "version": "0.1.0"
}
EOF

# Save final state
save_state "completed" "finalized"

log_info ""
log_info "=================================================="
log_info "Hedgehog Lab Appliance Initialization Complete!"
log_info "=================================================="
log_info ""
log_info "Build type: $BUILD_TYPE"
log_info "Steps completed: ${#STEPS_COMPLETED[@]}/$TOTAL_STEPS"
log_info "Initialization time: Started at $START_TIME"
log_info ""
log_info "Lab is ready for use."
log_info "Logs: $LOG_FILE"
log_info "State: $STATE_FILE"
log_info ""
log_info "Next steps:"
log_info "  - Run 'hh-lab status' to check service status (when implemented)"
log_info "  - Access services via their respective ports"
log_info ""

exit 0
