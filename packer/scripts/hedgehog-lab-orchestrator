#!/bin/bash
# hedgehog-lab-orchestrator
# Main orchestrator script for Hedgehog Lab Appliance initialization
# Runs on first boot to set up the lab environment

set -euo pipefail

# Configuration
LOCK_FILE="/var/lock/hedgehog-lab-init.lock"
LOG_FILE="/var/log/hedgehog-lab-init.log"
STAMP_FILE="/var/lib/hedgehog-lab/initialized"
BUILD_TYPE_FILE="/etc/hedgehog-lab/build-type"

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

# Error handling
error() {
    log "ERROR: $*"
    exit 1
}

# Check if already initialized
if [ -f "$STAMP_FILE" ]; then
    log "Lab already initialized. Exiting."
    exit 0
fi

# Acquire lock to prevent concurrent runs
if [ -f "$LOCK_FILE" ]; then
    log "Another initialization is in progress. Exiting."
    exit 0
fi

# Create lock file
touch "$LOCK_FILE"
trap "rm -f $LOCK_FILE" EXIT

# Start initialization
log "=================================================="
log "Hedgehog Lab Appliance Initialization Starting..."
log "=================================================="

# Detect build type
BUILD_TYPE="standard"
if [ -f "$BUILD_TYPE_FILE" ]; then
    BUILD_TYPE=$(cat "$BUILD_TYPE_FILE")
fi
log "Build type: $BUILD_TYPE"

# Create state directory
mkdir -p /var/lib/hedgehog-lab
mkdir -p /var/log/hedgehog-lab

# Display banner
cat <<'EOF'
  _   _          _            _                   _           _
 | | | | ___  __| | __ _  ___| |__   ___   __ _  | |     __ _| |__
 | |_| |/ _ \/ _` |/ _` |/ _ \ '_ \ / _ \ / _` | | |    / _` | '_ \
 |  _  |  __/ (_| | (_| |  __/ | | | (_) | (_| | | |___| (_| | |_) |
 |_| |_|\___|\__,_|\__, |\___|_| |_|\___/ \__, | |_____|\__,_|_.__/
                   |___/                  |___/
EOF

log ""
log "Initializing Hedgehog Lab Appliance..."
log ""

# For standard build, we need to initialize everything on first boot
if [ "$BUILD_TYPE" = "standard" ]; then
    log "Standard build detected - performing full initialization"

    # Step 1: Wait for network
    log "Step 1/5: Waiting for network connectivity..."
    while ! ping -c 1 -W 1 8.8.8.8 &>/dev/null; do
        sleep 2
    done
    log "Network is up"

    # Step 2: Initialize k3d cluster (placeholder)
    log "Step 2/5: Initializing k3d cluster..."
    log "k3d initialization will be implemented in future sprint"

    # Step 3: Initialize VLAB (placeholder)
    log "Step 3/5: Initializing Hedgehog VLAB..."
    log "VLAB initialization will be implemented in future sprint"

    # Step 4: Deploy GitOps stack (placeholder)
    log "Step 4/5: Deploying GitOps stack..."
    log "GitOps stack deployment will be implemented in future sprint"

    # Step 5: Deploy observability stack (placeholder)
    log "Step 5/5: Deploying observability stack..."
    log "Observability stack deployment will be implemented in future sprint"

else
    log "Pre-warmed build detected - starting services only"
    # For pre-warmed build, just start the services
    log "Service startup will be implemented in future sprint"
fi

# Mark as initialized
mkdir -p $(dirname "$STAMP_FILE")
date > "$STAMP_FILE"

log ""
log "=================================================="
log "Hedgehog Lab Appliance Initialization Complete!"
log "=================================================="
log ""
log "Lab is ready for use."
log "Run 'hh-lab status' to check service status."
log ""

exit 0
